---
# patroni.yml
#
# MANAGED BY ANSIBLE - DO NOT EDIT THIS FILE MANUALLY

scope: postgres-ha
namespace: /service/
name: {{ inventory_hostname }}

restapi:
  listen: 0.0.0.0:8008
  connect_address: {{ ansible_host }}:8008

{% set patroni_etcd_cluster_group = pg_setup_patroni_etcd_cluster_group | default(('etcd_primary' if inventory_hostname in groups.get('etcd_primary', []) else 'etcd_secondary')) %}
etcd3:
  hosts: {% for host in groups.get(patroni_etcd_cluster_group, []) %}{{ hostvars[host]['ansible_host'] }}:2379{% if not loop.last %},{% endif %}{% endfor %}

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 10
    maximum_lag_on_failover: 1048576
    postgresql:
      use_pg_rewind: true
      parameters:
        wal_level: replica
        archive_mode: on
        archive_command: 'test ! -f {{ pg_setup_patroni_pg_wal_archive_dir }}/%f && cp %p {{ pg_setup_patroni_pg_wal_archive_dir }}/%f'
        archive_timeout: 300
        max_connections: 1024
        hot_standby: on
        shared_buffers: {{ (ansible_memtotal_mb * 0.1) | int }}MB
        work_mem: {{ (ansible_memtotal_mb * 0.01) | int }}MB
        maintenance_work_mem: {{ (ansible_memtotal_mb * 0.04) | int }}MB
        wal_keep_size: 2GB
        # restore_command and recovery_target_timeline needed for Point-in-Time Recovery, but left commented out for now
        # restore_command: 'cp /var/lib/pgsql/backups/wal_archives/%f "%p"'
        # recovery_target_timeline: 'latest'
  initdb:
    - encoding: UTF8
    - locale: en_US.UTF-8
  users:
    admin:
      password: admin
      options:
        - createrole
        - createdb

postgresql:
  listen: 0.0.0.0:5432
  connect_address: {{ ansible_host }}:5432
  data_dir: {{ pg_setup_patroni_postgresql_data_dir }}
  bin_dir: {{ pg_setup_patroni_postgresql_bin_dir }}
  authentication:
    replication:
      username: {{ pg_setup_patroni_replication_user }}
      password: {{ pg_setup_patroni_replication_password }}
    superuser:
      username: postgres
      password: postgres
  pg_hba:
    # --- Local (Unix socket) ---
    # Allow the postgres OS user to admin via peer auth
    - local   all              postgres                                   peer
    # Normal local connections for everyone else
    - local   all              all                                        peer
    # *** IMPORTANT: allow replication over the socket ***
    - local   replication      postgres                                   peer
    - local   replication      {{ pg_setup_patroni_replication_user }}    scram-sha-256

    # --- Loopback (TCP) ---
    - host    all              all                    127.0.0.1/32        scram-sha-256
    - host    all              all                    ::1/128             scram-sha-256
    - host    replication      {{ pg_setup_patroni_replication_user }}    127.0.0.1/32   md5
    - host    replication      {{ pg_setup_patroni_replication_user }}    ::1/128        md5

    # --- LAN (TCP) ---
    - host    all              all                    0.0.0.0/0           scram-sha-256
    - host    replication      {{ pg_setup_patroni_replication_user }}    {{ pg_setup_patroni_replication_network }}   md5
...
